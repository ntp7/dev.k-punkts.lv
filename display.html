<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 0;
            margin: 0;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 18px;
            text-align: left;
        }
        th, td {
            padding: 12px;
            border-bottom: 1px solid #ddd;
        }
        th {
            background-color: #f2f2f2;
            cursor: pointer;
        }
        tr:hover {
            background-color: #f5f5f5;
        }
        .header-container {
            display: inline-flex;
            align-items: center;
        }
        .arrow {
            width: 16px;
            height: 16px;
            margin-left: 5px;
            transition: transform 0.2s;
        }
        .sorted {
            color: #f58b00;
            transform: scale(1.5);
        }
        input {
            width: 100%;
            border: none;
            background: none;
            outline: none;
            font-size: 16px;
        }
    </style>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.1.3/firebase-app.js";
        import { getFirestore, collection, getDocs, query, orderBy, updateDoc, doc } from "https://www.gstatic.com/firebasejs/9.1.3/firebase-firestore.js";
        import firebaseConfig from './firebaseconfig.js';

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        let currentSortedColumn = 1; // 1 for "Uzv훮rds"
        let isAscending = true; // To track sort direction for the current sorted column

document.addEventListener('DOMContentLoaded', async () => {
    const tableBody = document.querySelector('#participants-table tbody');

    try {
        const q = query(collection(db, 'pieteikums100km2025'), orderBy('submissionTime'));
        const querySnapshot = await getDocs(q);

        querySnapshot.forEach((docSnapshot) => {
            const data = docSnapshot.data();
            if (!data.hide) {  // Show only participants who are not hidden
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${data.vards}</td>
                    <td>${data.uzvards}</td>
                    <td><input type="text" value="${formatTime(data.KP1)}" data-field="KP1" data-id="${docSnapshot.id}" id="field" placeholder="hh:mm" maxlength="5"></td>
                    <td><input type="text" value="${formatTime(data.KP2)}" data-field="KP2" data-id="${docSnapshot.id}" id="field" placeholder="hh:mm" maxlength="5"></td>
                    <td><input type="text" value="${formatTime(data.KP3)}" data-field="KP3" data-id="${docSnapshot.id}" id="field" placeholder="hh:mm" maxlength="5"></td>
                    <td><input type="text" value="${formatTime(data.KP4)}" data-field="KP4" data-id="${docSnapshot.id}" id="field" placeholder="hh:mm" maxlength="5"></td>
                    <td><input type="text" value="${formatTime(data.KP5)}" data-field="KP5" data-id="${docSnapshot.id}" id="field" placeholder="hh:mm" maxlength="5"></td>
                `;
                tableBody.appendChild(row);
            }
        });

        sortTable(1, true); // Sort by "Uzv훮rds" (index 1) in ascending order when loaded

        // Add event listener for input changes
        document.getElementById("participants-table").addEventListener('input', (event) => {

            const input = event.target;
            if (input.tagName === 'INPUT') {
                const newValue = input.value;
                const field = input.dataset.field;
                const id = input.dataset.id;
                updateFieldInDatabase(id, field, newValue);
            }
        });

    } catch (error) {
        console.error("Error getting documents: ", error);
    }

    // Sort table on header click
    document.getElementById('name-header').addEventListener('click', () => {
        isAscending = !isAscending; // Toggle sort direction
        sortTable(0, isAscending);
    });

    document.getElementById('surname-header').addEventListener('click', () => {
        isAscending = !isAscending; // Toggle sort direction
        sortTable(1, isAscending);
    });
});

        // Function to format time from hh:mm:ss to hh:mm
        function formatTime(time) {
    if (!time) return ''; // Return empty if no time is provided

    const timeParts = time.split(' '); // Split into date and time parts
    if (timeParts.length < 2) return ''; // Ensure there is a time part

    const hhmmPart = timeParts[1]; // Get the time part (hh:mm)
    const hhmmParts = hhmmPart.split(':'); // Split the time into hours and minutes
    
    return hhmmParts.length >= 2 ? `${hhmmParts[0]}:${hhmmParts[1]}` : ''; // Return hh:mm format
}


// Function to combine input time with the current date and update in Firestore
// Function to combine input time with the current date and update in Firestore
function updateFieldInDatabase(id, field, value) {
    const docRef = doc(db, 'pieteikums100km2025', id);

    // If the input is empty, update the field in Firestore with an empty string
    if (!value) {
        updateDoc(docRef, {
            [field]: '' // Set the field to an empty string if the input is erased
        }).then(() => {
            console.log(`Cleared ${field} for document ${id}`);
        }).catch((error) => {
            console.error("Error updating document: ", error);
        });
    } else {
        // Get current date and time
        const now = new Date();
        const day = now.getDate().toString().padStart(2, '0');       // Returns day without zero-padding
        const month = now.getMonth() + 1; // Months are zero-indexed, so +1 is needed
        const year = now.getFullYear();
        const seconds = now.getSeconds().toString().padStart(2, '0'); // Get seconds and pad with leading zero if necessary

        // Ensure time value is in correct format (hh:mm)
        const timeParts = value.split(':');
        if (timeParts.length === 2) {
            // If only hours and minutes are provided, ensure leading zero in hours if necessary
            const hours = timeParts[0].padStart(2, '0'); // Pad with zero if necessary
            const minutes = timeParts[1].padStart(2, '0'); // Pad minutes as well

            // Construct the full timestamp (add current seconds)
            const currentDate = `${day}/${month}/${year}`;
            const fullTimestamp = `${currentDate} ${hours}:${minutes}:${seconds}`;

            updateDoc(docRef, {
                [field]: fullTimestamp // Update Firestore with full timestamp
            }).then(() => {
                console.log(`Updated ${field} for document ${id} to ${fullTimestamp}`);
            }).catch((error) => {
                console.error("Error updating document: ", error);
            });
        } else {
            console.error("Invalid time format. Please enter in hh:mm format.");
        }
    }
}






        function sortTable(columnIndex, ascending) {
            const table = document.getElementById('participants-table');
            const rows = Array.from(table.rows).slice(1); // Exclude header row

            // Reset arrows before sorting
            resetArrows();

            currentSortedColumn = columnIndex; // Update the currently sorted column

            // Sort rows based on the selected column
            rows.sort((a, b) => {
                const cellA = a.cells[columnIndex].textContent.trim().toLowerCase();
                const cellB = b.cells[columnIndex].textContent.trim().toLowerCase();
                return ascending ? cellA.localeCompare(cellB) : cellB.localeCompare(cellA);
            });

            rows.forEach(row => table.appendChild(row)); // Reappend rows to update the order

            // Update the arrow for the sorted column
            updateArrow(columnIndex, ascending);
        }

        function resetArrows() {
            const arrows = document.querySelectorAll('.arrow');
            arrows.forEach(arrow => {
                arrow.classList.remove('sorted');
                arrow.style.transform = 'scale(1)'; // Reset size
                arrow.style.transform = 'rotate(0deg)'; // Reset rotation
            });
        }

        function updateArrow(columnIndex, ascending) {
            const arrow = columnIndex === 0 ? document.querySelector('#name-header .arrow') : document.querySelector('#surname-header .arrow');
            arrow.classList.add('sorted');
            arrow.style.transform = 'scale(1.5)'; // Make the arrow larger when sorted
            arrow.style.transform = ascending ? 'scale(1.5) rotate(0deg)' : 'scale(1.5) rotate(180deg)'; // Arrow direction indication
        }
    </script>
</head>
<body>
    <table id="participants-table">
        <thead>
            <tr>
                <th id="name-header">
                    <span class="header-container">V훮rds 
                        <svg class="arrow" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                            <path d="M12 16l-6-6h12z" fill="currentColor"/>
                        </svg>
                    </span>
                </th>
                <th id="surname-header">
                    <span class="header-container">Uzv훮rds 
                        <svg class="arrow" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                            <path d="M12 16l-6-6h12z" fill="currentColor"/>
                        </svg>
                    </span>
                </th>
                <th>KP1</th>
                <th>KP2</th>
                <th>KP3</th>
                <th>KP4</th>
                <th>KP5</th>
            </tr>
        </thead>
        <tbody>
        </tbody>
    </table>
</body>
</html>
